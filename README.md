# TypechoRedisCache
Typecho的Redis缓存插件

-----

## TpCache 增强版：为 Typecho 带来 Memcached 与 Redis 缓存支持

TpCache 增强版是一款专为 Typecho 设计的缓存插件，旨在通过引入 Memcached 和 Redis 支持，显著提升您网站的加载速度和性能。本版本基于原版 TpCache 进行了功能修复与改进。

### 版本特性与修复

  * 感谢 [@Suroy](https://github.com/zsuroy/TpCache) 的贡献：
      * 修复了若干异常报错问题。
      * 提升了对多个 Typecho 版本的兼容性。
      * 修复了在直接使用 IP 访问时，各级永久链接显示为 IP 地址的问题，现已统一为域名显示。
      * 此版本主要为问题修复与兼容性提升，未新增核心功能。

### 重要兼容性说明

  * **与 Tepass 插件的兼容性：**
      * **加载顺序：** 请务必先启用 TpCache 插件，再启用 Tepass 插件。错误的加载顺序可能导致 Tepass 的付费文章内容被缓存，从而使得付费功能失效。
      * **默认行为：** 本插件已适配 Tepass，默认不会缓存 Tepass 的付费文章，以确保其功能正常。

### 核心缓存机制

插件提供以下几种缓存机制，您可以根据需求选择：

1.  **全局缓存 (Global Cache)**

      * **描述：** 启用全局缓存后，插件将缓存整个页面内容。此机制对于高访问量或服务器 TTFB (Time To First Byte) 响应时间较长的网站有显著优化效果。
      * **重要提示：** 采用全局缓存后，所有依赖 PHP 服务端（而非 JavaScript）动态实现的功能可能会失效。您可能需要手动修改部分主题或插件代码，将这些功能改为通过 JavaScript 实现。
      * **潜在影响示例：**
          * 基于 PHP Cookie 实现的文章阅读次数统计。
          * 基于 Typecho Cookie 实现的评论者信息自动填充。
      * 这些功能通常可以通过前端 JavaScript 技术进行兼容改造。

2.  **部分缓存 (Partial Cache)**

      * **描述：** 这是插件的默认缓存机制。它主要针对文章内容中 Markdown 转换后的 HTML 进行缓存，而不会缓存页面的其他动态组件。此方法特别适用于包含大量 Markdown 内容的长篇文章，能有效减少重复渲染的开销。
      * **潜在冲突：** 此机制可能会与同样使用了 Typecho `contentEx` 接口的其他插件产生冲突，请注意测试。

3.  **组件缓存 (Component Cache - Beta)**

      * **描述：** 此功能为高级用户设计，允许开发者自定义缓存任意数据片段，例如耗时较长的数据库查询结果等。请注意，若已启用全局缓存，则此组件缓存设置无效。

      * **使用方法：** 插件提供了以下接口供主题或插件开发者调用：

          * **设置缓存 (`TpCache_setCache`)**

              * **参数说明：**
                  * `$key` (string): 缓存的唯一标识符，可以是任意确保唯一的字符串。
                  * `$val` (mixed): 需要缓存的数据对象。插件内部采用 PHP 默认的 `serialize()` 进行序列化，不保证对所有类型的对象都完全有效。
              * **调用示例：**
                ```php
                <?php Typecho_Plugin::factory('TpCache.Widget_Cache')->TpCache_setCache($key, $val); ?>
                ```

          * **获取缓存 (`TpCache_getCache`)**

              * **描述：** 根据 `$key` 获取对应的缓存数据。如果缓存不存在或已过期，将返回 `false`。
              * **调用示例：**
                ```php
                <?php $cachedData = Typecho_Plugin::factory('TpCache.Widget_Cache')->TpCache_getCache($key); ?>
                ```

### 缓存自动更新触发条件

当发生以下任一操作时，相关缓存将自动更新或清除：

  * 通过 Typecho 原生评论系统发表新评论。
  * 在后台编辑并更新文章或页面。
  * 在后台管理或更新评论。
  * 重启缓存后端服务 (如 Memcached, Redis)。
  * 缓存达到预设的过期时间。
  * 删除文章或页面。

### 安装指南

1.  下载插件压缩包。
2.  解压后，请将插件文件夹**重命名**为 `TpCache` (确保大小写正确)。
3.  将 `TpCache` 文件夹上传至 Typecho 安装目录下的 `usr/plugins/` 目录。
4.  登录 Typecho 后台，进入“插件管理”页面，找到 TpCache 并启用。
5.  根据您的服务器环境，在插件设置中正确配置 Memcached 或 Redis 的连接信息。

### 升级说明

**重要：** 在升级插件之前，请务必**先在 Typecho 后台禁用当前版本的 TpCache 插件**。许多不明原因的错误都是由于未先禁用旧版插件而直接进行文件覆盖升级导致的。

### 验证缓存效果

您可以通过比较页面的 TTFB (Time To First Byte) 来直观判断缓存是否生效。

1.  **未开启缓存时：**
    使用浏览器开发者工具（通常按 F12 打开，选择 "Network" 标签页）查看页面加载时间。例如，下图显示未开启缓存时，一个页面的 TTFB 为 215ms：

2.  **开启缓存后：**
    启用 TpCache 并配置完成后，刷新同一页面。例如，下图显示开启缓存后，同一页面的 TTFB 显著降低至 70ms：

    TTFB 的显著降低表明缓存已成功生效，并提升了服务器响应速度。

-----
